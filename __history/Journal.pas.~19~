Unit Journal;

Interface

Uses
    Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
    Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.StdCtrls, Vcl.Grids, IncomeJournal, ExpenseJournal, DeleteJournal,
    Vcl.CheckLst, FilterJournal, System.Actions, Vcl.ActnList;

Type
    TFormJournal = class(TForm)
        ButtonOperationIncome: TButton;
        ButtonOperationDelete: TButton;
    StringGridJournalJ: TStringGrid;
    StringGridTemp: TStringGrid;
        ButtonOperationExpense: TButton;
    Button1: TButton;
    ButtonFilter: TButton;
    ButtonGraphic: TButton;

    procedure FormShow(Sender: TObject);
    procedure ButtonOperationIncomeClick(Sender: TObject);
    procedure ButtonOperationExpenseClick(Sender: TObject);
    procedure StringGridJournalJDrawCell(Sender: TObject; ACol, ARow: Integer;
      Rect: TRect; State: TGridDrawState);
    procedure ButtonOperationDeleteClick(Sender: TObject);
    procedure Button1Click(Sender: TObject);
    procedure ButtonFilterClick(Sender: TObject);
    procedure ButtonGraphicClick(Sender: TObject);

    Private
        { Private declarations }
    Public
        { Public declarations }
    End;

Var
    FormJournal: TFormJournal;
    IncomeOrExpense: Boolean;
    TempComboAccount, TempComboCategory: String;

Implementation
    {$R *.dfm}

Uses
    Main, UnitProcedure, UnitFilterProcedure;



Procedure TFormJournal.ButtonGraphicClick(Sender: TObject);
Var
    I, J: Integer;
    StringMatrix: TStringMatrix;
Begin
    StringMatrix := ActionMonthsInYear(StringGridTemp, 'a', '2022');
    StringMatrix := ActionLastOperation(StringGridTemp, 'b');
    StringMatrix := ActionCategoryOfAccount(StringGridTemp, 'a', '2022', '04', True);
    StringMatrix := ActionCategoryOfAccount(StringGridTemp, 'a', '2022', '04', False);


    With StringGridTemp do
    Begin
        RowCount := Length(StringMatrix);
        For I := 0 to 5 do
            Cols[I].Clear;

        For I := 0 to High(StringMatrix) do
            For J := 0 to High(StringMatrix[0]) do
                StringGridTemp.Cells[J, I] := StringMatrix[I, J];
    End;

End;


Procedure TFormJournal.FormShow(Sender: TObject);
Begin
    SetStartJournal(StringGridJournalJ);
    FillJournal(StringGridJournalJ);
End;


Procedure TFormJournal.ButtonOperationIncomeClick(Sender: TObject);
Begin
    IncomeOrExpense := True;
    FormCreateRecordJournal.Show;
End;


Procedure DeleteJournalStringGrid(Var StringGridJournal: TStringGrid);
Var
    I, J: Integer;
Begin
    For I := StringGridJournal.Row to StringGridJournal.RowCount - 1 do
    Begin
        For J := 0 to 5 do
            StringGridJournal.Cells[J,I] := StringGridJournal.Cells[J,I + 1];
    End;
    StringGridJournal.RowCount := StringGridJournal.RowCount - 1;
End;


Procedure DeleteJournalElement(Var StringGridJournal: TStringGrid);
Var
    CurrentPointer: PJournal;
    I: Integer;
Begin
    DataHasChanged := True;
    PointerJournal := HeadJournal;

    While PointerJournal^.Next^.ID <> StrToInt(StringGridJournal.Cells[0, StringGridJournal.Row]) do
        PointerJournal := PointerJournal^.Next;

    CurrentPointer := PointerJournal^.Next;
    FindLineInAccountList(CurrentPointer^.Account, CurrentPointer^.Amount * (-1), True);
    PointerJournal^.Next := CurrentPointer^.Next;
    CurrentPointer^.Next := nil;
    Dispose(CurrentPointer);
    If PointerJournal^.Next = nil then
        TailJournal := PointerJournal;
    HeadJournal^.ID := HeadJournal^.ID - 1;
End;


Procedure TFormJournal.Button1Click(Sender: TObject);
Begin
    If StringGridJournalJ.Row <> 0 then
    Begin
        If MessageBox(Application.Handle,'Вы действительно хотите удалить данную операцию?','Внимание',MB_YESNO+MB_ICONWARNING) = IDYES then
        Begin
            DeleteJournalElement(StringGridJournalJ);
            DeleteJournalStringGrid(StringGridJournalJ);
        End;
    End;
End;


Procedure TFormJournal.ButtonFilterClick(Sender: TObject);
Begin
    FormFilterJournal.Show;
End;


Procedure TFormJournal.ButtonOperationDeleteClick(Sender: TObject);
Begin
    FormDeleteJournal.Show;
End;


Procedure TFormJournal.ButtonOperationExpenseClick(Sender: TObject);
Begin
    IncomeOrExpense := False;
    FormExpenseJournal.Show;
End;


Procedure TFormJournal.StringGridJournalJDrawCell(Sender: TObject; ACol, ARow: Integer; Rect: TRect; State: TGridDrawState);
Begin
    FillColorInGrid(StringGridJournalJ, ACol, ARow, Rect, State);
    FillColorChoiceRecord(StringGridJournalJ, ACol, ARow, Rect, State);
End;

End.
