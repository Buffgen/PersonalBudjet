Unit IncomeJournal;

Interface

Uses
    Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
    Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Vcl.Grids, Vcl.StdCtrls, ChoiceAccount,
  Vcl.ComCtrls;

Type
    TFormIncomeJournal = class(TForm)
        StringGridJournal: TStringGrid;
        ComboBoxAccount: TComboBox;
        EditAmount: TEdit;
        ButtonExecute: TButton;
        LabelAccount: TLabel;
        LabelAmount: TLabel;
        LabelDate: TLabel;
        LabelComment: TLabel;
        EditComment: TEdit;
        DateTimePickerJournal: TDateTimePicker;
    procedure FormShow(Sender: TObject);
    procedure EditAmountKeyPress(Sender: TObject; var Key: Char);
    procedure ButtonExecuteClick(Sender: TObject);
    procedure ComboBoxAccountDropDown(Sender: TObject);
    procedure ComboBoxAccountChange(Sender: TObject);
    procedure FormClose(Sender: TObject; var Action: TCloseAction);
    procedure StringGridJournalDrawCell(Sender: TObject; ACol, ARow: Integer;
      Rect: TRect; State: TGridDrawState);

    Private
        Procedure AddNewJournalElement();
        Procedure AddNewJournalStringGrid();

    Public
        { Public declarations }
    End;

Var
    FormIncomeJournal: TFormIncomeJournal;

Implementation
    {$R *.dfm}

Uses
    Main, UnitProcedure, Journal;




Procedure TFormIncomeJournal.FormShow(Sender: TObject);
Begin
    TempComboAccount := '';
    EditAmount.Clear;
    DateTimePickerJournal.Date := Now;
    SetStartIncomeJournal(StringGridJournal);
    FillIncomeJournal(StringGridJournal);
End;


Procedure TFormIncomeJournal.StringGridJournalDrawCell(Sender: TObject; ACol, ARow: Integer; Rect: TRect; State: TGridDrawState);
Begin
    FillColorInGrid(StringGridJournal, ACol, ARow, Rect, State);
End;


Procedure TFormIncomeJournal.EditAmountKeyPress(Sender: TObject; var Key: Char);
Begin
    Key := CheckKeyEditMoney(EditAmount.Text, EditAmount.SelStart, EditAmount.SelLength, Key);
End;


Procedure TFormIncomeJournal.AddNewJournalElement();
Begin
    DataHasChanged := True;
    Inc(MaxJournalID);
    PointerJournal := TailJournal;
    New(PointerJournal^.Next);
    PointerJournal := PointerJournal^.Next;
    PointerJournal^.Next := Nil;
    PointerJournal^.ID := MaxJournalID;
    PointerJournal^.Account := ComboBoxAccount.Text;
    PointerJournal^.Amount := StrToFloat(EditAmount.Text);
    PointerJournal^.Date := DateTimePickerJournal.Date;
    PointerJournal^.Comment := EditComment.Text;
    TailJournal := PointerJournal;
    HeadJournal^.ID := HeadJournal^.ID + 1;
End;


Procedure TFormIncomeJournal.AddNewJournalStringGrid();
Begin
    With StringGridJournal do
    Begin
        RowCount :=  RowCount + 1;
        Cells[0, RowCount - 1] := PointerJournal^.Account;
        Cells[1, RowCount - 1] := FloatToStr(PointerJournal^.Amount);
        Cells[2, RowCount - 1] := DateTimeToStr(PointerJournal^.Date);
        Cells[3, RowCount - 1] := PointerJournal^.Comment;
    End;
End;


Procedure TFormIncomeJournal.ButtonExecuteClick(Sender: TObject);
Begin
    AddNewJournalElement();
    AddNewJournalStringGrid();
    ComboBoxAccount.Text := '';
    EditAmount.Clear;
    EditComment.Clear;
End;


Procedure TFormIncomeJournal.ComboBoxAccountDropDown(Sender: TObject);
    Var
    I: Integer;
Begin
    ComboBoxAccount.Items.Clear;
    PointerAccount := HeadAccount^.Next;
    I := 0;
    While (I < 5) and (PointerAccount <> nil) do
    Begin
        ComboBoxAccount.Items.Add(PointerAccount^.Name);
        PointerAccount := PointerAccount^.Next;
        Inc(I);
    End;
    If PointerAccount <> nil then
    Begin
        If TempComboAccount <> '' then
            ComboBoxAccount.Items.Add(TempComboAccount);
        ComboBoxAccount.Items.Add('ƒругой счЄт...');
    End;
End;


Procedure TFormIncomeJournal.ComboBoxAccountChange(Sender: TObject);
Begin
    If TempComboAccount <> '' then
    Begin
        If ComboBoxAccount.ItemIndex = 6 then
            FormChoiceAccount.Show
    End
    Else If ComboBoxAccount.ItemIndex = 5 then
        FormChoiceAccount.Show
End;


Procedure TFormIncomeJournal.FormClose(Sender: TObject; var Action: TCloseAction);
Begin
    FillJournal(FormJournal.StringGridJournal);
    TempComboAccount := '';
End;

End.
